import "Arrays";
import "net";
import "math";

let server = net.NewServer();
let users = {};

func handleRoot(req, res) {
    res.writeHeader("Content-Type", "application/json");
    // res.writeStatus(201);
    res.write('{"message": "Hello"}');
    res.end();
}

func handleStream(req, res) {
    res.writeHeader("Content-Type", "text/plain");
    res.writeHeader("Transfer-Encoding", "chunked");
    // Stream data here
    for let i = 0; i < 10000; i = i + 1 {
        res.write("Chunk " + i + "\n");
        res.flush();
        // Simulate some delay
        for let j = 0; j < 1000000; j = j + 1 {
            999 * 999;
        }
    }
    res.end();
}

func addUser(req,res) {
    let splits = req.path.split('/');
    let userId = splits[splits.length - 1];
    users[userId] = users;
    let str = '' + users;
    res.json('{"message": "'+  str +'"}');
}


print "Registering handlers to server: " + server;
let p = server.post;
let g = server.get;
// server.post("/user/:id", addUser);
print "Starting server on port 2000";
server.get("/", handleRoot);
server.get("/stream", handleStream);
server.printHandlers();
server.listen(2000);
