import "fs";
import "net";
import "math";
import "json";
import "http";
import "os";

let f = fs.open("test.txt", "r");
func handleStream(req, res) {
    res.writeHeader("Content-Type", "text/plain");
    res.writeHeader("Transfer-Encoding", "chunked");
    // Stream data here;
    for let i = 0; i < f.length() / 1024; i = i + 1 {
        let result = f.read(math.min(1024, f.length() - i * 1024));
        let chunk = result[0];
        let err = result[1];
        if err != nil {
            print "Error reading file chunk: " + err;
            break;
        }
        // let chunk = content.substring(i * 1024, (i + 1) * 1024);
        res.write(chunk);
    }
    res.end();
}

let server = new net.Server();
server.get("/stream", handleStream);

server.get("/forward", (req, res) => {
    print req;
    let bodyString = req.body();
    let body = json.parse(bodyString);
    let id = body.a.d.c.d.e;
    print "ID: " + id;
    http.request(
        "GET",
        "https://fakerapi.it/api/v2/persons?_seed=" + id,
        {"Content-Type": "application/json"},
        "",
        (data, err) => {
            if err != nil {
                print "HTTP request error: " + err;
                return;
            }
            let person = json.parse(data.body).data[0];
            print "Person: " + person;
            res.writeHeader("Content-Type", "application/json");
            res.writeStatus(data.status);
            res.write('' + person);
            res.end();
        }
    );
});

server.listen(2000);

print "Server started on port http://localhost:2000";